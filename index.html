<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FRED CITY</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
      :root{--blue:#6684ff;--cyan:#66d6ff;--teal:#078992;--darkteal:#316679;--bright:#0eefff;--yellow:#ffe566;--green:#5dea7a;--red:#ff5566;}*{margin:0;padding:0;box-sizing:border-box;}body{font-family:'Nunito',sans-serif;background:var(--blue);height:100vh;overflow:hidden; touch-action:none;}.screen{display:none;width:100vw;height:100vh;position:absolute;top:0;left:0;}.screen.active{display:flex;}
      #screen-title{flex-direction:column;align-items:center;justify-content:center;overflow:hidden;background:linear-gradient(180deg, #112244 0%, #224488 100%);}.title-snow{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:1;}.snowflake{position:absolute;border-radius:50%;background:rgba(102,214,255,0.55);animation:snowfall linear infinite;}@keyframes snowfall{0%{transform:translateY(-20px);opacity:1}100%{transform:translateY(100vh) translateX(30px);opacity:0}}.title-logo{font-family:'Fredoka One',cursive;display:flex;align-items:center;gap:.2rem;filter:drop-shadow(5px 5px 0 rgba(0,0,0,.55));margin-bottom:.6rem;position:relative;z-index:2;}.title-logo-letter{font-size:clamp(3.5rem,8vw,6.5rem);color:var(--cyan);text-shadow:4px 4px 0 #000,6px 6px 0 rgba(0,0,0,.3);display:inline-block;animation:letterBob 2.2s ease-in-out infinite;}@keyframes letterBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-14px)}}.title-fred-wrap{position:relative;z-index:2;margin-bottom:.8rem;filter:drop-shadow(0 4px 16px rgba(0,0,0,.45));animation:fredFloat 3s ease-in-out infinite;}@keyframes fredFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}.title-subtitle{color:rgba(180,240,255,.9);font-size:clamp(.75rem,1.5vw,1rem);font-weight:700;letter-spacing:.22em;text-transform:uppercase;margin-bottom:1.6rem;position:relative;z-index:2;text-shadow:1px 1px 3px rgba(0,0,0,.5);}.title-btn-play{background:var(--bright);border:none;border-radius:18px;padding:.9rem 4.5rem;color:var(--darkteal);font-family:'Fredoka One',cursive;font-size:clamp(1.4rem,3vw,2rem);cursor:pointer;letter-spacing:.05em;position:relative;z-index:2;box-shadow:0 6px 0 var(--darkteal),0 0 30px rgba(14,239,255,.55);transition:all .15s;}.title-btn-play:hover{transform:translateY(-3px);box-shadow:0 9px 0 var(--darkteal),0 0 45px rgba(14,239,255,.75);}.title-btn-play:active{transform:translateY(3px);box-shadow:0 3px 0 var(--darkteal);}
      
      #screen-auth{flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(160deg,#2233aa 0%,#5566ee 50%,#3355cc 100%);}.auth-back-btn{position:absolute;top:1.2rem;left:1.2rem;padding:.5rem 1rem;background:rgba(0,0,0,.35);border:2px solid rgba(102,214,255,.5);border-radius:10px;color:var(--cyan);font-family:'Nunito',sans-serif;font-weight:700;font-size:.9rem;cursor:pointer;transition:all .15s;z-index:5;}.auth-logo{font-family:'Fredoka One',cursive;font-size:2.2rem;color:var(--cyan);text-shadow:3px 3px 0 #000;margin-bottom:1.5rem;position:relative;z-index:2;}.auth-box{background:rgba(0,0,0,.45);border:3px solid var(--cyan);border-radius:22px;padding:2rem 2.5rem;width:clamp(300px,90vw,380px);backdrop-filter:blur(12px);box-shadow:0 0 35px rgba(102,214,255,.3),inset 0 1px 0 rgba(255,255,255,.1);position:relative;z-index:2;}.auth-tabs{display:flex;gap:.5rem;margin-bottom:1.5rem;}.auth-tab{flex:1;padding:.6rem;border:2px solid var(--cyan);background:transparent;color:var(--cyan);font-family:'Nunito',sans-serif;font-weight:700;font-size:1rem;border-radius:10px;cursor:pointer;transition:all .2s;}.auth-tab.active{background:var(--cyan);color:#000;}.auth-field{margin-bottom:1rem;}.auth-field label{display:block;color:var(--cyan);font-size:.8rem;font-weight:700;margin-bottom:.35rem;text-transform:uppercase;}.auth-field input{width:100%;padding:.7rem 1rem;background:rgba(0,0,0,.4);border:2px solid rgba(102,214,255,.35);border-radius:10px;color:#fff;font-family:'Nunito',sans-serif;font-size:1rem;outline:none;}.auth-field input:focus{border-color:var(--cyan);}.btn-main{width:100%;padding:.9rem;background:var(--cyan);border:none;border-radius:12px;color:#000;font-family:'Fredoka One',cursive;font-size:1.2rem;cursor:pointer;transition:all .15s;box-shadow:0 4px 0 var(--darkteal);}.btn-main:hover{transform:translateY(-2px);box-shadow:0 6px 0 var(--darkteal);}.auth-msg{color:var(--red);font-size:.85rem;font-weight:700;margin-top:.8rem;text-align:center;min-height:1.2em;}.auth-msg.ok{color:var(--green);}
      
      #screen-map{flex-direction:column; background:#a2d149;} .map-header{position:absolute;top:0;left:0;right:0;height:56px;background:rgba(0,0,0,.55);backdrop-filter:blur(8px);border-bottom:2px solid var(--cyan);display:flex;align-items:center;padding:0 1rem;gap:1rem;z-index:10;}.map-header-title{font-family:'Fredoka One',cursive;color:var(--cyan);font-size:1.3rem;letter-spacing:.05em;}.hud-coins{background:rgba(255,229,102,.12);border:2px solid var(--yellow);border-radius:20px;padding:.2rem .7rem;color:var(--yellow);font-weight:800;font-size:.9rem;display:flex;align-items:center;gap:.3rem;margin-left:auto;}.map-back-btn,.shop-back-btn,.admin-hdr-btn{padding:.4rem .9rem;background:rgba(0,0,0,.4);border:2px solid var(--cyan);border-radius:8px;color:var(--cyan);font-family:'Nunito',sans-serif;font-weight:700;font-size:.85rem;cursor:pointer;transition:all .15s;}.map-back-btn:hover{background:rgba(102,214,255,.2)}.admin-hdr-btn{border-color:#ff5566;color:#ff5566;display:none;}.admin-hdr-btn:hover{background:rgba(255,85,102,.2)}#map-canvas{position:absolute;top:56px;left:0;width:100vw;height:calc(100vh - 56px);display:block;}.map-hint{position:absolute;bottom:1rem;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);border:2px solid var(--cyan);border-radius:12px;padding:.5rem 1.2rem;color:var(--cyan);font-size:.8rem;font-weight:700;pointer-events:none;}.zone-popup{position:absolute;display:none;background:rgba(0,0,20,.88);border:2px solid var(--cyan);border-radius:14px;padding:1rem 1.5rem;color:#fff;text-align:center;backdrop-filter:blur(10px);z-index:20;transform:translate(-50%,-130%);}.zone-popup h3{font-family:'Fredoka One',cursive;color:var(--cyan);font-size:1.1rem;margin-bottom:.4rem;}.zone-popup .enter-btn{background:var(--cyan);border:none;border-radius:8px;padding:.5rem 1.2rem;color:#000;font-family:'Fredoka One',cursive;font-size:1rem;cursor:pointer;margin-top:.5rem;box-shadow:0 3px 0 var(--darkteal);transition:all .15s;}.zone-popup .enter-btn:hover{transform:translateY(-2px);}

      /* ADMIN PANEL */
      .admin-panel-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}.admin-panel-overlay.show{display:flex;}.admin-modal{background:linear-gradient(160deg,#2a1a2a,#4a1a2a);border:3px solid var(--red);border-radius:20px;padding:1.5rem;width:95%;max-width:500px;box-shadow:0 0 40px rgba(255,85,102,.35),0 20px 60px rgba(0,0,0,.5);animation:confirmPop .2s ease;}.admin-modal h2{color:var(--red);font-family:'Fredoka One',cursive;margin-bottom:.5rem;text-align:center;}.admin-btn{width:100%;padding:.8rem;background:rgba(255,85,102,.15);border:2px solid var(--red);border-radius:12px;color:#fff;font-family:'Fredoka One',cursive;font-size:1.1rem;cursor:pointer;transition:all .15s;margin-bottom:0.8rem;}.admin-btn:hover{background:var(--red);color:#000;}.admin-btn.safe{border-color:var(--cyan);background:rgba(102,214,255,.15);}.admin-btn.safe:hover{background:var(--cyan);color:#000;}.admin-player-list{max-height:150px;overflow-y:auto;background:rgba(0,0,0,.5);border-radius:10px;padding:1rem;margin-bottom:1rem;}.admin-player-item{display:flex;justify-content:space-between;align-items:center;padding:.5rem;border-bottom:1px solid rgba(255,255,255,.1);color:#fff;font-size:.9rem;}.admin-kick-btn{padding:.3rem .6rem;background:var(--red);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:bold;}

      /* OTHER UI / OVERLAYS */
      .teleport-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:300;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}.teleport-overlay.show{display:flex;}
      .map-modal { background:linear-gradient(160deg,#1a2a4a,#2a3a5e); border:3px solid var(--cyan); border-radius:20px; padding:1.5rem; width:95%; max-width:650px; text-align:center; box-shadow:0 0 40px rgba(102,214,255,.35),0 20px 60px rgba(0,0,0,.5); animation:confirmPop .2s ease; }
      .mini-map-container { position:relative; width:100%; aspect-ratio:1.5 / 1; background:#a2d149; border:3px solid var(--darkteal); border-radius:12px; overflow:hidden; margin:0 auto 1rem auto; box-shadow:inset 0 0 20px rgba(0,0,0,0.2); }
      .mm-pin { position:absolute; transform:translate(-50%, -50%); background:#fff; border:2px solid #000; border-radius:50%; width:clamp(28px, 5vw, 40px); height:clamp(28px, 5vw, 40px); font-size:clamp(0.9rem, 2.5vw, 1.4rem); cursor:pointer; z-index:20; box-shadow:0 4px 0 rgba(0,0,0,0.3); transition:all 0.15s; display:flex; align-items:center; justify-content:center; padding:0; outline:none; }
      .mm-pin:hover { transform:translate(-50%, -60%) scale(1.15); box-shadow:0 6px 0 rgba(0,0,0,0.3); border-color:var(--cyan); }
      .mm-label { position:absolute; transform:translateX(-50%); color:#fff; font-family:'Fredoka One',cursive; font-size:clamp(0.6rem, 2vw, 0.85rem); text-shadow:2px 2px 0 #000,-1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000, 1px 1px 0 #000; pointer-events:none; z-index:20; text-align:center; white-space:nowrap; }
      .mm-path, .mm-path-horiz { position:absolute; background:rgba(213,237,249,0.7); border-radius:10px; }
      .mm-path { left:19.5%; top:12.5%; width:1%; height:25%; } .mm-path-horiz { left:4.3%; top:20.5%; width:30%; height:1.5%; }
      .mm-lake { position:absolute; left:33.3%; top:25%; width:13.3%; height:12.5%; background:#00aaff; border-radius:50%; transform:translate(-50%, -50%); border:2px solid rgba(0,0,255,0.1); }
      .mm-mountain { position:absolute; left:11.6%; top:10%; width:0; height:0; border-left:4vw solid transparent; border-right:4vw solid transparent; border-bottom:5vw solid #555; transform:translate(-50%, -100%); }
      .mm-house { position:absolute; width:2%; height:2.5%; background:#D7CCC8; border:1px solid rgba(0,0,0,0.3); transform:translate(-50%, -50%); }

      #fred-dialogue { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:400; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
      .fred-box { background:linear-gradient(160deg,#1a2a4a,#2a3a5e); border:4px solid #ffaa00; border-radius:24px; padding:2rem; max-width:450px; width:90%; text-align:center; box-shadow:0 0 50px rgba(255,170,0,0.3); display:flex; flex-direction:column; align-items:center; animation:confirmPop .2s ease; }

      .invite-notif{position:fixed;top:1.5rem;left:50%;transform:translateX(-50%) translateY(-150%);opacity: 0; pointer-events: none;background:linear-gradient(135deg,#1a2a4a,#2a3a5e);border:3px solid var(--cyan);border-radius:18px;padding:1.2rem 1.5rem;min-width:320px;max-width:90vw;box-shadow:0 0 30px rgba(102,214,255,.4),0 10px 40px rgba(0,0,0,.5);z-index:500;transition:transform .4s cubic-bezier(.34,1.56,.64,1), opacity .4s ease;text-align:center;}.invite-notif.show{transform:translateX(-50%) translateY(0);opacity: 1; pointer-events: auto;}.invite-notif-title{font-family:'Fredoka One',cursive;color:var(--cyan);font-size:1.2rem;margin-bottom:.2rem;}.invite-notif-sub{color:rgba(255,255,255,.65);font-size:.85rem;margin-bottom:1rem;}.invite-notif-btns{display:flex;gap:.7rem;}.invite-accept{flex:1;padding:.7rem;background:var(--green);border:none;border-radius:10px;color:#000;font-family:'Fredoka One',cursive;font-size:1rem;cursor:pointer;transition:all .15s;}.invite-accept:hover{transform:translateY(-2px);}.invite-decline{flex:1;padding:.7rem;background:rgba(255,85,102,.15);border:2px solid var(--red);border-radius:10px;color:var(--red);font-family:'Fredoka One',cursive;font-size:1rem;cursor:pointer;transition:all .15s;}
      .invite-pending{position:fixed;top:1.5rem;right:1.5rem;background:rgba(0,0,20,.9);border:2px solid var(--yellow);border-radius:12px;padding:.8rem 1.2rem;color:var(--yellow);font-weight:700;font-size:.85rem;z-index:499;display:none;}.invite-pending.show{display:flex;align-items:center;gap:.5rem;}

      /* GLOBAL GAME UI Overlay */
      .game-over-overlay { position:fixed; inset:0; display:none; flex-direction:column; align-items:center; justify-content:center; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); z-index:2000; }
      .game-over-title { font-family:'Fredoka One',cursive; font-size:clamp(3rem,8vw,5rem); color:var(--yellow); text-shadow:4px 4px 0 #000; margin-bottom:1rem; text-align:center; }
      .game-over-sub { font-size:1.5rem; color:#fff; font-weight:bold; margin-bottom:2rem; text-align:center; }

      .confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:300;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}.confirm-overlay.show{display:flex;}.confirm-box{background:linear-gradient(160deg,#1a2a4a,#2a3a5e);border:3px solid var(--cyan);border-radius:22px;padding:2rem 2.5rem;max-width:360px;width:90%;text-align:center;box-shadow:0 0 40px rgba(102,214,255,.35),0 20px 60px rgba(0,0,0,.5);animation:confirmPop .2s ease;}.confirm-item-name{font-family:'Fredoka One',cursive;font-size:1.6rem;color:#fff;margin-bottom:.3rem;}.confirm-price{color:var(--yellow);font-weight:800;font-size:1.1rem;margin-bottom:1.5rem;}.confirm-balance{color:rgba(255,255,255,.5);font-size:.85rem;margin-bottom:1.5rem;}.confirm-btns{display:flex;gap:.8rem;}.confirm-yes{flex:1;padding:.8rem;background:var(--cyan);border:none;border-radius:12px;color:#000;font-family:'Fredoka One',cursive;font-size:1.1rem;cursor:pointer;box-shadow:0 4px 0 var(--darkteal);}.confirm-no{flex:1;padding:.8rem;background:rgba(255,255,255,.08);border:2px solid rgba(255,255,255,.2);border-radius:12px;color:rgba(255,255,255,.7);font-family:'Fredoka One',cursive;font-size:1.1rem;cursor:pointer;}

      .loading-overlay{position:fixed;inset:0;background:var(--blue);z-index:400;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem;transition:opacity .6s;}.loading-overlay.hide{opacity:0;pointer-events:none;}.loading-title{font-family:'Fredoka One',cursive;font-size:3rem;color:var(--cyan);text-shadow:4px 4px 0 #000;}.loading-bar-outer{width:200px;height:12px;background:rgba(0,0,0,.3);border-radius:6px;border:2px solid var(--cyan);overflow:hidden;}.loading-bar-inner{height:100%;background:var(--cyan);border-radius:6px;animation:loadBar 1.8s ease forwards;}@keyframes loadBar{0%{width:0}100%{width:100%}}.toast{position:fixed;bottom:1.5rem;right:1.5rem;background:rgba(0,0,20,.9);border:2px solid var(--cyan);border-radius:12px;padding:.8rem 1.2rem;color:#fff;font-weight:700;font-size:.9rem;transform:translateX(130%);transition:transform .3s;z-index:2000;max-width:260px;}.toast.show{transform:translateX(0);}
    </style>
  </head>
  <body>
    <div class="loading-overlay" id="loading">
      <div class="loading-title">FRED CITY</div>
      <div class="loading-bar-outer"><div class="loading-bar-inner"></div></div>
      <div style="color:rgba(102,214,255,.7);font-size:.9rem;font-weight:600;">Loading the world...</div>
    </div>
    <div class="toast" id="toast"></div>

    <div class="game-over-overlay" id="game-over-overlay">
      <div class="game-over-title" id="go-title">WINNER!</div>
      <div class="game-over-sub" id="go-sub">The game has ended!</div>
      <button class="btn-main" style="max-width:200px;" onclick="leaveGlobalGame()">Back to Map</button>
    </div>
    
    <div class="teleport-overlay" id="teleport-overlay" onclick="if(event.target===this) closeTeleportMenu()">
      <div class="map-modal">
        <h2 style="color:var(--cyan);font-family:'Fredoka One',cursive;margin-bottom:1rem;">üó∫Ô∏è World Map</h2>
        <div class="mini-map-container">
            <div class="mm-path"></div>
            <div class="mm-path-horiz"></div>
            <div class="mm-lake"></div>
            <div class="mm-mountain"></div>
            
            <button class="mm-pin" style="left: 20%; top: 32.5%;" onclick="teleportTo(1200, 1300)">üåü</button>
            <div class="mm-label" style="left: 20%; top: 39%;">Town Center</div>

            <button class="mm-pin" style="left: 19.1%; top: 10.5%;" onclick="teleportTo(1150, 450)">‚öîÔ∏è</button>
            <div class="mm-label" style="left: 19.1%; top: 17%;">Arena</div>

            <button class="mm-pin" style="left: 10%; top: 25%;" onclick="teleportTo(600, 1050)">üè™</button>
            <div class="mm-label" style="left: 10%; top: 31.5%;">Shop</div>

            <button class="mm-pin" style="left: 33.3%; top: 25%;" onclick="teleportTo(2000, 1000)">üåä</button>
            <div class="mm-label" style="left: 33.3%; top: 31.5%;">Lake</div>

            <button class="mm-pin" style="left: 11.6%; top: 5%;" onclick="teleportTo(700, 300)">‚õ∞Ô∏è</button>
            <div class="mm-label" style="left: 11.6%; top: 11.5%;">Mountain</div>
            
            <button class="mm-pin" style="left: 33.3%; top: 20%; font-size:1rem;" onclick="teleportTo(2000, 800)">üè†</button>
            <div class="mm-label" style="left: 33.3%; top: 26.5%;">Fred's House</div>
        </div>
        <button style="padding:0.8rem 2rem; background:rgba(255,255,255,.1); border:2px solid var(--red); color:#fff; border-radius:10px; cursor:pointer; font-family:'Fredoka One',cursive; font-size:1.1rem; transition:all .2s;" onclick="closeTeleportMenu()">Close Map</button>
      </div>
    </div>

    <div class="admin-panel-overlay" id="admin-panel-overlay" onclick="if(event.target===this) closeAdminPanel()">
      <div class="admin-modal">
        <h2>üëë ADMIN CONTROLS</h2>
        
        <button class="admin-btn safe" onclick="startGlobalGame('Hide & Seek')">üôà 1. Start Hide & Seek Lobby</button>
        <button class="admin-btn safe" onclick="startGlobalGame('Tag')">üèÉ 1. Start Tag Lobby</button>
        <button class="admin-btn" onclick="pickSeeker()" style="background:var(--yellow); color:#000; border-color:var(--yellow);">üéØ 2. Pick Random Seeker</button>
        <button class="admin-btn" onclick="beginGlobalGame()" style="background:var(--green); color:#000; border-color:var(--green);">‚ñ∂Ô∏è 3. Begin Game (Start!)</button>
        <button class="admin-btn" onclick="endGlobalGame()" style="margin-top:10px;">üõë End Current Game</button>
        
        <h3 style="color:#fff;font-family:'Fredoka One',cursive;margin:1rem 0 .5rem;font-size:1rem;">Online Players</h3>
        <div class="admin-player-list" id="admin-player-list"></div>
        <button class="admin-btn safe" style="background:transparent;border-color:#555;color:#aaa;" onclick="closeAdminPanel()">Close Panel</button>
      </div>
    </div>

    <div id="fred-dialogue">
       <div class="fred-box">
           <img src="costume1.svg" width="90" style="background:#ffe566; border-radius:50%; border:3px solid #000; padding:5px; margin-bottom:1rem;">
           <h3 style="color:#fff; margin-bottom: 1.5rem; font-size:1.2rem; line-height:1.4;" id="fred-text">...</h3>
           <button class="btn-main" onclick="closeFred()" id="fred-btn">Got it!</button>
       </div>
    </div>

    <div class="invite-notif" id="invite-notif">
      <div class="invite-notif-title" id="invite-notif-title">‚öîÔ∏è Battle Challenge!</div>
      <div class="invite-notif-sub" id="invite-notif-sub">Someone invited you to a battle!</div>
      <div class="invite-notif-btns">
        <button class="invite-accept" onclick="respondInvite(true)">Accept!</button>
        <button class="invite-decline" onclick="respondInvite(false)">Decline</button>
      </div>
    </div>
    
    <div class="screen active" id="screen-title">
      <div class="title-snow" id="title-snow"></div>
      <div class="title-logo" style="position:relative;z-index:2">
        <span class="title-logo-letter">F</span><span class="title-logo-letter">R</span><span class="title-logo-letter">E</span><span class="title-logo-letter">D</span>
        <div class="title-logo-gap"></div>
        <span class="title-logo-letter">C</span><span class="title-logo-letter">I</span><span class="title-logo-letter">T</span><span class="title-logo-letter">Y</span>
      </div>
      <div class="title-fred-wrap" id="title-fred-wrap">
        <img src="costume1.svg" width="130" alt="Fred" style="display:block; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.5));" onerror="this.style.display='none'" />
      </div>
      <div class="title-subtitle">fred is cool</div>
      <button class="title-btn-play" onclick="clickPlay()">‚ñ∂ PLAY</button>
    </div>
    
    <div class="screen" id="screen-auth">
      <button class="auth-back-btn" onclick="showScreen('screen-title')">‚Üê Back</button>
      <div class="auth-logo">FRED CITY</div>
      <div class="auth-box">
        <div class="auth-tabs">
          <button class="auth-tab active" onclick="switchTab('login')">Login</button>
          <button class="auth-tab" onclick="switchTab('register')">Sign Up</button>
        </div>
        <div id="auth-login-fields">
          <div class="auth-field"><label>Email</label><input type="email" id="login-email" placeholder="you@example.com" /></div>
          <div class="auth-field"><label>Password</label><input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
        </div>
        <div id="auth-register-fields" style="display:none">
          <div class="auth-field"><label>Username</label><input type="text" id="reg-username" placeholder="FreddyFred" /></div>
          <div class="auth-field"><label>Email</label><input type="email" id="reg-email" placeholder="you@example.com" /></div>
          <div class="auth-field"><label>Password</label><input type="password" id="reg-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
        </div>
        <button class="btn-main" id="auth-submit-btn" onclick="doAuth()">Play Now!</button>
        <div class="auth-msg" id="auth-msg"></div>
      </div>
    </div>
    
    <div class="screen" id="screen-map">
      <div class="map-header">
        <button class="map-back-btn" onclick="doLogout()">‚Üê Logout</button>
        
        <button class="map-back-btn" id="nav-map-btn" onclick="openTeleportMenu()">üó∫Ô∏è Map</button>
        <button class="map-back-btn" id="nav-leave-btn" style="display:none;background:#ff5566;color:#fff;border-color:#fff;" onclick="leaveGlobalGame()">üö™ Leave Game</button>
        
        <button class="admin-hdr-btn" id="admin-hdr-btn" onclick="openAdminPanel()">üëë Admin</button>
        <div class="map-header-title">üó∫ The World</div>
        <div style="color:rgba(255,255,255,.5);font-size:.85rem;font-weight:700;" id="map-username-hud"></div>
        <div class="hud-coins">ü™ô <span class="coins-hud">0</span></div>
      </div>
      <canvas id="map-canvas"></canvas>
      <div class="map-hint" id="map-hint">WASD to move ¬∑ Walk to interact</div>
      <div class="zone-popup" id="zone-popup">
        <h3 id="zone-popup-title">Zone</h3>
        <p id="zone-popup-desc" style="font-size:.82rem;color:rgba(255,255,255,.65);margin-bottom:.4rem;"></p>
        <button class="enter-btn" id="zone-popup-btn">Enter!</button>
      </div>
    </div>

    <script>
const costume1Img = new Image();
costume1Img.src = "costume1.svg";

// MAP NAV LOGIC
function switchMap(mapId, startX, startY) {
    G.currentMap = mapId;
    map.player.x = startX;
    map.player.y = startY;
    updateNavButtons();
}

function updateNavButtons() {
    const mapBtn = document.getElementById('nav-map-btn');
    const leaveBtn = document.getElementById('nav-leave-btn');
    if(mapBtn && leaveBtn) {
        if(G.currentMap === 'main') {
            mapBtn.style.display = 'block';
            leaveBtn.style.display = 'none';
        } else {
            mapBtn.style.display = 'none';
            leaveBtn.style.display = 'block';
        }
    }
}

function openTeleportMenu() { document.getElementById('teleport-overlay').classList.add('show'); }
function closeTeleportMenu() { document.getElementById('teleport-overlay').classList.remove('show'); }
function teleportTo(x, y) { map.player.x = x; map.player.y = y; closeTeleportMenu(); }

// ADMIN FUNCTIONS
function openAdminPanel() {
    const list = document.getElementById('admin-player-list');
    list.innerHTML = '';
    Object.keys(otherPlayers).forEach(id => {
        const p = otherPlayers[id];
        const el = document.createElement('div');
        el.className = 'admin-player-item';
        el.innerHTML = `<span>${p.username}</span> <button class="admin-kick-btn" onclick="kickPlayer('${id}', '${p.username}')">Kick</button>`;
        list.appendChild(el);
    });
    if(list.innerHTML === '') list.innerHTML = '<span style="color:#aaa;">No other players online</span>';
    document.getElementById('admin-panel-overlay').classList.add('show');
}
function closeAdminPanel() { document.getElementById('admin-panel-overlay').classList.remove('show'); }

function kickPlayer(uid, name) {
    if(!firebaseReady) return;
    db.ref('users/' + uid).update({ kick: true }).catch(e=>console.log(e));
    showToast(`Kicked ${name}!`);
    closeAdminPanel();
}

function startGlobalGame(gameName) {
    if(!firebaseReady) return;
    db.ref('global_game').set({ active: true, name: gameName, seeker: null, state: 'lobby' });
    
    // Send invites to EVERYONE
    Object.keys(otherPlayers).forEach(uid => {
        db.ref('invites/' + uid).push().set({
            from: G.uid, fromName: 'üëë Admin', type: 'global_game', game: gameName, status: 'pending', createdAt: firebase.database.ServerValue.TIMESTAMP 
        });
    });
    
    showToast(`Started global game lobby! Pick a seeker, then Begin.`);
    switchMap('minigame_map', 6000, 6000); // Admin auto joins the new map
}

function pickSeeker() {
    if(!firebaseReady) return;
    let pool = Object.keys(otherPlayers).filter(id => otherPlayers[id].currentMap === 'minigame_map');
    if (G.currentMap === 'minigame_map') pool.push(G.uid);
    
    if(pool.length === 0) { showToast("No one has joined the map yet!"); return; }
    
    let chosen = pool[Math.floor(Math.random() * pool.length)];
    let chosenName = chosen === G.uid ? G.username : otherPlayers[chosen].username;
    
    db.ref('global_game').update({ seeker: chosen, seekerName: chosenName });
    showToast(`Random Seeker chosen: ${chosenName}!`);
}

function beginGlobalGame() {
    if(!firebaseReady) return;
    if(!globalGameState.seeker) { showToast("Pick a seeker first!"); return; }
    
    let hiders = {};
    let pool = Object.keys(otherPlayers).filter(id => otherPlayers[id].currentMap === 'minigame_map');
    if (G.currentMap === 'minigame_map') pool.push(G.uid);
    
    pool.forEach(uid => {
        if(uid !== globalGameState.seeker) hiders[uid] = false; // False = NOT caught
    });

    db.ref('global_game').update({ state: 'playing', hiders: hiders });
    closeAdminPanel();
}

function endGlobalGame() {
    if(!firebaseReady) return;
    db.ref('global_game').set({ active: false });
    switchMap('main', 1200, 1300);
    showToast("Global game ended.");
    closeAdminPanel();
}

function leaveGlobalGame() {
    switchMap('main', 1200, 1300);
    document.getElementById('game-over-overlay').style.display = 'none';
    showToast("Left the game.");
}

// FIREBASE
const firebaseConfig = { 
  apiKey: "AIzaSyCYydCGhgmawcrjwNXf_0eqTaDe-O6p1eQ", 
  authDomain: "fred-city.firebaseapp.com", 
  databaseURL: "https://fred-city-default-rtdb.firebaseio.com", 
  projectId: "fred-city", 
  storageBucket: "fred-city.firebasestorage.app", 
  messagingSenderId: "961837899685", 
  appId: "1:961837899685:web:297780aa142021853fd24c"
};

let firebaseReady=false, db, auth;
try { 
  if(!firebase.apps.length) firebase.initializeApp(firebaseConfig); 
  db = firebase.database(); 
  auth = firebase.auth(); 
  firebaseReady = true; 
} catch(e) { 
  console.warn('Firebase fallback:', e); 
}

let G={ uid:null, email: '', username:'Fred', coins:100, color:'#ffffff', hat:'none', currentMap: 'main'};
let otherPlayers = {};
let globalGameState = { active: false, seeker: null, state: 'lobby', name: '' };

function showScreen(id){ 
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); 
    const s=document.getElementById(id); if(!s)return; 
    s.classList.add('active'); 
    if(id==='screen-map') initMap(); 
}
function clickPlay() { if (G.uid && !G.uid.startsWith('demo')) { showScreen('screen-map'); } else { showScreen('screen-auth'); } }

let currentTab='login';
function switchTab(tab){ currentTab=tab; document.querySelectorAll('.auth-tab').forEach((t,i)=>{ t.classList.toggle('active',(i===0&&tab==='login')||(i===1&&tab==='register')); }); document.getElementById('auth-login-fields').style.display=tab==='login'?'':'none'; document.getElementById('auth-register-fields').style.display=tab==='register'?'':'none'; document.getElementById('auth-submit-btn').textContent=tab==='login'?'Play Now!':'Create Account!'; }
function setAuthMsg(msg,ok=false){ const el=document.getElementById('auth-msg'); el.textContent=msg; el.className='auth-msg'+(ok?' ok':''); }

async function doAuth(){
  if(!firebaseReady){ const un=(currentTab==='register'?document.getElementById('reg-username').value.trim():document.getElementById('login-email').value.split('@')[0])||'Fred'; G.username=un; G.uid='demo_'+Date.now(); showScreen('screen-map'); showToast('üëã Welcome, '+G.username+'! (Demo)'); return; }
  if(currentTab==='login'){
    const email=document.getElementById('login-email').value.trim(); const pass=document.getElementById('login-pass').value;
    if(!email||!pass){setAuthMsg('Please fill all fields');return;}
    try{ setAuthMsg('Logging in...'); await auth.signInWithEmailAndPassword(email,pass); showScreen('screen-map'); showToast('Welcome back!'); }
    catch(e){ setAuthMsg(e.message); }
  } else {
    const username=document.getElementById('reg-username').value.trim(); const email=document.getElementById('reg-email').value.trim(); const pass=document.getElementById('reg-pass').value;
    if(!username||!email||!pass){setAuthMsg('Please fill all fields');return;}
    try{ 
      setAuthMsg('Creating account...'); 
      const cred=await auth.createUserWithEmailAndPassword(email,pass); 
      const data={username, email, coins:100, color:'#ffffff',hat:'none',online:true, x: 1200, y: 1300, currentMap: 'main'}; 
      await db.ref('users/' + cred.user.uid).set(data); 
      setAuthMsg('Account created!',true); showScreen('screen-map'); showToast('Welcome to the world!'); 
    } catch(e){ setAuthMsg(e.message); }
  }
}

async function doLogout(){
  if(firebaseReady && G.uid && !G.uid.startsWith('demo')){
    await db.ref('users/' + G.uid).update({online:false}).catch(()=>{});
    await auth.signOut();
  }
  window.location.reload(); 
}

async function loadUserData(uid){ 
  if(!firebaseReady)return; 
  try { 
    const snap = await db.ref('users/' + uid).once('value'); 
    if(snap.exists()) Object.assign(G, snap.val(), {uid}); 
  } catch(e){} 
}

let prevGameState = null;
let prevSeeker = null;

function listenToPlayers() {
  if(!firebaseReady) return;
  
  db.ref('users/' + G.uid + '/kick').on('value', snap => {
      if(snap.val() === true) {
          db.ref('users/' + G.uid + '/kick').remove();
          alert("You have been kicked by an Admin.");
          doLogout();
      }
  });

  db.ref('global_game').on('value', snap => {
      if(snap.exists()) {
          globalGameState = snap.val();
          
          if(globalGameState.seeker && globalGameState.seeker !== prevSeeker) {
              showToast("üö® SEEKER CHOSEN: " + (globalGameState.seekerName || 'Someone') + "!");
              prevSeeker = globalGameState.seeker;
          }

          if(globalGameState.state === 'playing' && prevGameState !== 'playing') {
              showToast("üèÉ‚Äç‚ôÇÔ∏èüí® GAME STARTED! RUN AND HIDE!");
          }
          
          if(globalGameState.state === 'game_over' && prevGameState !== 'game_over') {
              document.getElementById('go-title').textContent = "SEEKER WINS!";
              document.getElementById('go-sub').textContent = globalGameState.winner + " caught everyone!";
              document.getElementById('game-over-overlay').style.display = 'flex';
          }

          prevGameState = globalGameState.state;
      } else {
          globalGameState = { active: false, seeker: null, state: 'lobby', name: '' };
          if(G.currentMap !== 'main' && prevGameState !== null) {
              leaveGlobalGame(); 
              showToast("The minigame has ended.");
          }
          prevGameState = null; prevSeeker = null;
      }
  });

  db.ref('users').on('value', snap => {
    const currentIds = new Set();
    snap.forEach(child => {
      const docId = child.key;
      const d = child.val();
      if (docId !== G.uid && d.online === true) {
        currentIds.add(docId);
        if (!otherPlayers[docId]) {
          otherPlayers[docId] = { ...d, targetX: d.x || 1200, targetY: d.y || 1300, x: d.x || 1200, y: d.y || 1300 };
        } else {
          otherPlayers[docId].targetX = d.x !== undefined ? d.x : otherPlayers[docId].x;
          otherPlayers[docId].targetY = d.y !== undefined ? d.y : otherPlayers[docId].y;
          otherPlayers[docId].username = d.username;
          otherPlayers[docId].hat = d.hat;
          otherPlayers[docId].color = d.color;
          otherPlayers[docId].currentMap = d.currentMap || 'main';
        }
      }
    });
    Object.keys(otherPlayers).forEach(id => {
      if (!currentIds.has(id)) delete otherPlayers[id];
    });
  });
}

let _syncTimer;
function startPositionSync() {
  if(!firebaseReady) return;
  clearInterval(_syncTimer);
  _syncTimer = setInterval(() => {
    if (document.getElementById('screen-map').classList.contains('active') && G.uid && !G.uid.startsWith('demo')) {
        db.ref('users/' + G.uid).update({ x: Math.round(map.player.x), y: Math.round(map.player.y), currentMap: G.currentMap }).catch(e => console.log(e));
    }
  }, 100); 
}

if(firebaseReady){ 
  auth.onAuthStateChanged(async user=>{ 
    if(user){ 
      await loadUserData(user.uid); 
      G.uid=user.uid; 
      if(user.email) G.email = user.email;
      
      if(G.email === 'masonlevihess@gmail.com') {
          document.getElementById('admin-hdr-btn').style.display = 'block';
      }
      
      const userRef = db.ref('users/' + user.uid);
      db.ref('.info/connected').on('value', snap => {
        if (snap.val() === true) {
          userRef.update({online: true});
          userRef.onDisconnect().update({online: false}); 
        }
      });
      
      updateNavButtons();
      startInviteListener(); listenToPlayers(); startPositionSync(); 
    } 
    hideLoading(); showScreen('screen-title'); 
  }); 
} else { setTimeout(()=>{hideLoading();showScreen('screen-title');},1800); }
function hideLoading(){ document.getElementById('loading').classList.add('hide'); }

// Rendering Fallbacks
function drawFred(ctx,x,y,size,color,hat){
  const s=size/100; ctx.save(); ctx.translate(x-size*0.5,y-size*0.48); ctx.scale(s,s);
  ctx.beginPath(); ctx.ellipse(50,50,40,37,0,0,Math.PI*2); ctx.fillStyle=color||'#ffffff'; ctx.fill(); ctx.strokeStyle='#000'; ctx.lineWidth=6; ctx.stroke();
  ctx.beginPath(); ctx.ellipse(50,60,17,13,0,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,0.35)'; ctx.fill();
  ctx.save(); ctx.translate(34,41); ctx.rotate(-0.15); ctx.beginPath(); ctx.ellipse(0,0,5,6.5,0,0,Math.PI*2); ctx.fillStyle='#000'; ctx.fill(); ctx.restore(); ctx.beginPath(); ctx.arc(36,39,2,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
  ctx.save(); ctx.translate(63,39); ctx.rotate(0.15); ctx.beginPath(); ctx.ellipse(0,0,5,6.5,0,0,Math.PI*2); ctx.fillStyle='#000'; ctx.fill(); ctx.restore(); ctx.beginPath(); ctx.arc(65,37,2,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
  ctx.strokeStyle='#000'; ctx.lineWidth=2.5; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(36,68); ctx.quadraticCurveTo(50,80,64,68); ctx.stroke();
  ctx.restore();
}

const MAP_W=6000, MAP_H=4000;
const map={canvas:null,ctx:null,cam:{x:0,y:0}, player:{x:1200,y:1300,speed:4.5,size:28},keys:{},animFrame:null};

function initMap(){
  map.canvas=document.getElementById('map-canvas'); if(!map.canvas)return; map.canvas.width=window.innerWidth; map.canvas.height=window.innerHeight-56; map.ctx=map.canvas.getContext('2d');
  document.removeEventListener('keydown',mapKD); document.removeEventListener('keyup',mapKU); document.addEventListener('keydown',mapKD); document.addEventListener('keyup',mapKU); cancelAnimationFrame(map.animFrame); mapLoop();
}

function mapKD(e){ if(!document.getElementById('screen-map').classList.contains('active'))return; map.keys[e.key.toLowerCase()]=true; if(['w','a','s','d','arrowup','arrowdown','arrowleft','arrowright'].includes(e.key.toLowerCase()))e.preventDefault(); }
function mapKU(e){map.keys[e.key.toLowerCase()]=false;}

function mapLoop(){ if(!document.getElementById('screen-map').classList.contains('active'))return; updateMap(); renderMap(); map.animFrame=requestAnimationFrame(mapLoop); }

// Catch Mechanics
function catchPlayer(uid, name) {
    if(!firebaseReady) return;
    if(globalGameState.name === 'Tag') {
        db.ref('global_game').update({ seeker: uid, seekerName: name });
        showToast(`üèÉ ${name} is now IT!`);
    } else if(globalGameState.name === 'Hide & Seek') {
        if(!globalGameState.hiders || globalGameState.hiders[uid] === true) return;
        
        db.ref('global_game/hiders/' + uid).set(true);
        showToast(`üëª Found ${name}!`);
        
        // Check win condition
        db.ref('global_game/hiders').once('value', snap => {
            let allFound = true;
            snap.forEach(c => { if(c.val() === false && c.key !== uid) allFound = false; });
            if(allFound) {
                db.ref('global_game').update({ state: 'game_over', winner: globalGameState.seekerName });
            }
        });
    }
}

function updateMap(){
  const p=map.player;
  p.speed = 4.5; 
  if(map.keys['w']||map.keys['arrowup']) p.y-=p.speed; if(map.keys['s']||map.keys['arrowdown']) p.y+=p.speed; if(map.keys['a']||map.keys['arrowleft']) p.x-=p.speed; if(map.keys['d']||map.keys['arrowright']) p.x+=p.speed;
  
  const curW = G.currentMap === 'minigame_map' ? 12000 : MAP_W;
  const curH = G.currentMap === 'minigame_map' ? 12000 : MAP_H;
  
  p.x=Math.max(p.size,Math.min(curW-p.size,p.x)); p.y=Math.max(p.size,Math.min(curH-p.size,p.y));
  const cw=map.canvas.width,ch=map.canvas.height; map.cam.x=Math.max(0,Math.min(curW-cw,p.x-cw/2)); map.cam.y=Math.max(0,Math.min(curH-ch,p.y-ch/2));
  
  // Tag / Hide&Seek Collision checking
  if (globalGameState.active && globalGameState.state === 'playing' && globalGameState.seeker === G.uid) {
      Object.values(otherPlayers).forEach(op => {
          if (op.currentMap === G.currentMap) {
              let isCaught = globalGameState.hiders && globalGameState.hiders[op.uid];
              if (!isCaught) {
                  let dx = op.x - p.x, dy = op.y - p.y;
                  if (Math.sqrt(dx*dx + dy*dy) < 50) { // Catch radius
                      catchPlayer(op.uid, op.username);
                  }
              }
          }
      });
  }

  Object.values(otherPlayers).forEach(op => {
    if (op.x !== undefined && op.targetX !== undefined && op.currentMap === G.currentMap) {
      op.x += (op.targetX - op.x) * 0.15; 
      op.y += (op.targetY - op.y) * 0.15;
    }
  });
}

// Seeded Random for Hiding Spots
function getSeededRandom(s) { let x = Math.sin(s) * 10000; return x - Math.floor(x); }
let hsSpots = [];
let seedNum = 12345;
for(let i=0; i<350; i++) {
    hsSpots.push({
        x: getSeededRandom(seedNum++) * 12000, 
        y: getSeededRandom(seedNum++) * 12000,
        type: getSeededRandom(seedNum++) > 0.4 ? 'tree' : 'bush'
    });
}

function renderMap(){
  const ctx=map.ctx; if(!ctx)return; ctx.save(); ctx.translate(-map.cam.x,-map.cam.y);
  
  if (G.currentMap === 'minigame_map') {
      // 1. Draw Background
      ctx.fillStyle='#132616'; ctx.fillRect(0,0,12000,12000); 
      
      // 2. Draw Bottom of Hiding Spots (Trunks & Bush Shadows)
      hsSpots.forEach(s => { 
          if(s.type === 'tree') {
              ctx.fillStyle='#2b1a10'; ctx.fillRect(s.x-10, s.y+10, 20, 30); 
          } else {
              ctx.fillStyle='rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.ellipse(s.x, s.y+20, 40, 20, 0, 0, Math.PI*2); ctx.fill();
          }
      });

      // 3. Draw Players (Drawn BEFORE the leaves, so they can hide under them!)
      drawAllPlayers(ctx);

      // 4. Draw Tops of Hiding Spots (Canopies & Leaves)
      hsSpots.forEach(s => { 
          if(s.type === 'tree') {
              ctx.fillStyle='#1a4a2a'; ctx.beginPath(); ctx.arc(s.x, s.y-60, 60, 0, Math.PI*2); ctx.fill();
              ctx.beginPath(); ctx.arc(s.x-30, s.y-40, 50, 0, Math.PI*2); ctx.fill();
              ctx.beginPath(); ctx.arc(s.x+30, s.y-40, 50, 0, Math.PI*2); ctx.fill();
          } else {
              ctx.fillStyle='#1e592f'; ctx.beginPath(); ctx.arc(s.x, s.y, 55, 0, Math.PI*2); ctx.fill();
              ctx.fillStyle='#25733b'; ctx.beginPath(); ctx.arc(s.x-20, s.y-10, 40, 0, Math.PI*2); ctx.fill();
              ctx.beginPath(); ctx.arc(s.x+20, s.y-10, 40, 0, Math.PI*2); ctx.fill();
          }
      });

  } else {
      ctx.fillStyle='#a2d149'; ctx.fillRect(0,0,MAP_W,MAP_H); 
      ctx.fillStyle='#00aaff'; ctx.beginPath(); ctx.ellipse(2000, 1000, 400, 250, 0, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle='#d5edf9'; ctx.lineWidth=60; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.beginPath(); ctx.moveTo(1200, 1500); ctx.lineTo(1200, 500); ctx.stroke();
      drawAllPlayers(ctx);
  }
  
  ctx.restore();
}

function drawAllPlayers(ctx) {
  Object.values(otherPlayers).forEach(p => {
    if(p.x !== undefined && p.y !== undefined && p.currentMap === G.currentMap) {
      
      let isCaught = globalGameState.hiders && globalGameState.hiders[p.uid];
      if(isCaught) ctx.globalAlpha = 0.4; // Ghost effect
      
      if (costume1Img.complete && costume1Img.naturalHeight !== 0) { 
        ctx.beginPath(); ctx.arc(p.x, p.y, 22, 0, Math.PI * 2); ctx.fillStyle = p.color || '#ffffff'; ctx.fill();
        ctx.drawImage(costume1Img, p.x - 30, p.y - 30, 60, 60); 
      } else { drawFred(ctx, p.x, p.y, 60, p.color || '#ffffff'); }
      
      ctx.globalAlpha = 1.0;
      
      let showName = true;
      if (G.currentMap !== 'main' && globalGameState.state === 'playing') showName = false;
      if (isCaught) showName = true; // Always show caught players

      if(showName && !isCaught) {
          ctx.font="bold 14px 'Nunito',sans-serif"; ctx.textAlign='center'; ctx.fillStyle=G.currentMap!=='main'?'#fff':'#333';
          ctx.fillText(p.username || 'Player', p.x, p.y-40);
      }
      
      if(isCaught) {
          ctx.fillStyle = '#ff5566'; ctx.font="bold 14px 'Fredoka One',cursive";
          ctx.fillText("üëª CAUGHT", p.x, p.y-45);
      }
      
      if(globalGameState.active && globalGameState.seeker === p.uid) {
          ctx.fillStyle = '#ff2244'; ctx.font="bold 20px 'Fredoka One',cursive";
          ctx.fillText("üî¥ IT", p.x, p.y-50);
      }
    }
  });

  // Draw Self
  let amICaught = globalGameState.hiders && globalGameState.hiders[G.uid];
  if(amICaught) ctx.globalAlpha = 0.4;
  
  if (costume1Img.complete && costume1Img.naturalHeight !== 0) { 
    ctx.beginPath(); ctx.arc(map.player.x, map.player.y, 22, 0, Math.PI * 2); ctx.fillStyle = G.color || '#ffffff'; ctx.fill();
    ctx.drawImage(costume1Img, map.player.x - 30, map.player.y - 30, 60, 60); 
  } else { drawFred(ctx, map.player.x, map.player.y, 60, G.color); }
  
  ctx.globalAlpha = 1.0;
  
  let showMyName = true;
  if (G.currentMap !== 'main' && globalGameState.state === 'playing') showMyName = false;
  
  if(showMyName && !amICaught) {
      ctx.font="bold 14px 'Nunito',sans-serif"; ctx.textAlign='center'; ctx.fillStyle=G.currentMap!=='main'?'#fff':'#333';
      ctx.fillText(G.username, map.player.x, map.player.y-40);
  }

  if(amICaught) {
      ctx.fillStyle = '#ff5566'; ctx.font="bold 14px 'Fredoka One',cursive";
      ctx.fillText("üëª CAUGHT", map.player.x, map.player.y-45);
  }
  
  if(globalGameState.active && globalGameState.seeker === G.uid) {
      ctx.fillStyle = '#ff2244'; ctx.font="bold 20px 'Fredoka One',cursive";
      ctx.fillText("üî¥ IT", map.player.x, map.player.y-50);
  }
}

let _inviteIsGlobal = false, _pendingInviteId = null, _inviteTimeout = null;
function startInviteListener(){ 
  if(!firebaseReady) return; 
  db.ref('invites/' + G.uid).on('child_added', snap => {
    const inv = snap.val();
    if(inv && inv.status === 'pending') {
        _pendingInviteId=snap.key; 
        if(inv.type === 'global_game') {
            _inviteIsGlobal = true;
            document.getElementById('invite-notif-title').textContent = `üéÆ NEW GAME: ${inv.game}!`;
            document.getElementById('invite-notif-sub').textContent = `${inv.fromName} has started a game!`;
        } else {
            _inviteIsGlobal = false;
        }
        document.getElementById('invite-notif').classList.add('show'); 
        _inviteTimeout = setTimeout(()=>{ if(document.getElementById('invite-notif').classList.contains('show')) respondInvite(false); },25000); 
    }
  }); 
}

async function respondInvite(accept){ 
  document.getElementById('invite-notif').classList.remove('show'); 
  if(!_pendingInviteId) return; 
  const id = _pendingInviteId; _pendingInviteId = null; clearTimeout(_inviteTimeout);
  
  if (firebaseReady) {
    if (_inviteIsGlobal && accept) { 
        await db.ref('invites/' + G.uid + '/' + id).update({status:'accepted'}); 
        showToast('üå≤ Teleporting to the map...'); 
        switchMap('minigame_map', 6000, 6000);
    } else { 
        await db.ref('invites/' + G.uid + '/' + id).update({status:'declined'}); 
    }
  }
}
function showToast(msg){ const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
    </script>
  </body>
</html>
